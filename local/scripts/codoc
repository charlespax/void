#!/usr/bin/env bash

# Notes #######################################################################
# The original command alias for vimdoc, the predacessor for codoc
# TODO codoc tag can be specified directly within the file, overrides default
# TODO find all codoc files in a specified directory

# Header Information ##########################################################
#
# Name: System Dope codoc in-line documentation viewer

# Script Metadata and Constants ###############################################
SCRIPT_NAME="codoc"
SCRIPT_VERSION="0.0.1"
SCRIPT_LICENSE="gplv3"
DOPE_VERSION="0.0.1"

# Global Varaibles ############################################################
CODOC_TAG='CODOC'
COMMAND=""
TARGET_FILE=""
# TODO ~/.config/codoc  # list of files that codoc should be aware of
CONFIG_FILE=""

# Usage #######################################################################
USAGE="Usage: ${SCRIPT_NAME} [OPTION]... [COMMAND]...
In-line documentation viewer
Example: ${SCRIPT_NAME} vimrc  # display vimrc codoc information
Example: ${SCRIPT_NAME} list  # display list of supported files

Commands:
  list      print list of supported files

Flags:
  -c, --config=CONFIG_FILE  define CONFIG_FILE
  -f, --file=TARGET_FILE    define TARGET_FILE
  -h, --help                print this help message
  -t, --tag=CODOC_TAG       define CODOC_TAG
  -v, --version             print this script's name and version

Notes
- The first non-flag argument defines COMMAND
- All arguments after the first non-flag argument will be ignored\n"

# Argument Processing #########################################################
if [[ $# == 0 ]]; then  # if zero arguments, print USAGE and exit
	printf "${USAGE}"
	exit
fi
while [[ $# -gt 0 ]]; do
	case "${1}" in
	# Flag Arguments
		-c|--config)
			shift
			CONFIG_FILE="${1}"
			shift
			;;
		-f|--file)
			shift
			TARGET_FILE="${1}"
			shift
			;;
		-h|--help)
			printf "${USAGE}"
			exit
			;;
		-t|--tag)
			shift
			CODOC_TAG="${1}"
			shift
			;;
		-v|--version)
			printf "${SCRIPT_NAME} ${SCRIPT_VERSION}\n"
			exit
			;;
		-*)
			printf "Unknown flag: ${1}\n"
			exit
			;;
	# Non-flag Arguments
		*)  # The first non-flag argument defines COMMAND
			COMMAND="${1}"
			break  # ignore all proceeding argument
			;;
	esac
done

# Function Declarations #######################################################

# function: printlines
function printlines {
	TARGET_FILE="${1}"
	grep "${CODOC_TAG}" "${TARGET_FILE}" | sed 's/^.'*$CODOC_TAG'//g'
}


# Main Program Logic ##########################################################

# TODO put the known files into an array, iterate over array
case "${COMMAND}" in
	"bashrc") # COODOOC bashrc
		TARGET_FILE=~/.bashrc
		;;
	"codoc") # COODOOC codoc
		CODOC_TAG='COOD'
		CODOC_TAG+='OOC'
		TARGET_FILE=~/.local/scripts/codoc
		;;
	"list")
		printf "$(${0} codoc)\n"
		exit
		;;
	"sdiwctl") # COODOOC sdiwctl
		TARGET_FILE=~/.local/scripts/sdiwctl
		;;
	"vimrc") # COODOOC vimrc
		TARGET_FILE=~/.config/vim/vimrc
		;;
	*)
		printf "Unknown command: ${COMMAND}\n"
		exit
		;;
esac

printlines "${TARGET_FILE}"
