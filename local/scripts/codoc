#!/usr/bin/env bash

# Notes #######################################################################
# The original command alias for vimdoc, the predacessor for codoc
# TODO codoc tag can be specified directly within the file, overrides default
# TODO find all codoc files in a specified directory
# COODOOC This is a test

# Header Information ##########################################################
#
# Name: System Dope codoc in-line documentation viewer

# Script Metadata and Constants ###############################################
SCRIPT_NAME="codoc"
SCRIPT_VERSION="0.0.1"
SCRIPT_LICENSE="gplv3"
DOPE_VERSION="0.0.1"

# Global Varaibles ############################################################
CODOC_TAG="CODOC"
COMMAND=""
TARGET_FILE=""
CONFIG_FILE="${HOME}/.config/codocrc"
CODOC_DIRS=""
declare -A CODOCS=""

# Usage #######################################################################
USAGE="Usage: ${SCRIPT_NAME} [OPTION]... [COMMAND]...
In-line documentation viewer
Example: ${SCRIPT_NAME} vimrc  # display vimrc codoc information
Example: ${SCRIPT_NAME} list  # display list of supported files

Commands:
  list      print list of supported files
  info      print list of supported files and locations

Flags:
  -c, --config=CONFIG_FILE  define CONFIG_FILE
  -f, --file=TARGET_FILE    define TARGET_FILE
  -h, --help                print this help message
  -t, --tag=CODOC_TAG       define CODOC_TAG
  -v, --version             print this script's name and version

Notes
- The first non-flag argument defines COMMAND
- All arguments after the first non-flag argument will be ignored\n"

# Argument Processing #########################################################
if [[ $# == 0 ]]; then  # if zero arguments, print USAGE and exit
	printf "${USAGE}"
	exit
fi
while [[ $# -gt 0 ]]; do
	case "${1}" in
	# Flag Arguments
		-c|--config)
			shift
			CONFIG_FILE="${1}"
			shift
			;;
		-f|--file)
			shift
			TARGET_FILE="${1}"
			shift
			;;
		-h|--help)
			printf "${USAGE}"
			exit
			;;
		-t|--tag)
			shift
			CODOC_TAG="${1}"
			shift
			;;
		-v|--version)
			printf "${SCRIPT_NAME} ${SCRIPT_VERSION}\n"
			exit
			;;
		-*)
			printf "Unknown flag: ${1}\n"
			exit
			;;
	# Non-flag Arguments
		*)  # The first non-flag argument defines COMMAND
			COMMAND="${1}"
			break  # ignore all proceeding argument
			;;
	esac
done

# Function Declarations #######################################################

# function: printlines
function printlines {
	TARGET_FILE="${1}"
	grep "${CODOC_TAG}" "${TARGET_FILE}" | sed 's/^.'*$CODOC_TAG.'//g'
}

# function: list_files
# List all the available codoc files
# TODO sort list
# TODO unique entries only
# TODO drop empty array elements
# TODO use local variables, printf output
function list_files {
	local MYARRAY
	local WORKING_LINE
	for entry in "${!CODOCS[@]}"; do
		WORKING_LINE="${CODOCS[${entry}]}"
		WORKING_LINE="$(basename ${WORKING_LINE} | tr -d .)"
		MYARRAY+="${WORKING_LINE}\n"
	done
	for entry in "${MYARRAY[@]}"; do
		printf "${entry}\n"
	done
}

# function: list_info
# List all the available codoc files and locations
function list_info {
	for entry in "${!CODOCS[@]}"; do
		location="${CODOCS[${entry}]}"
		printf "File: ${entry}: ${location}\n"
	done
	for entry in "${CODOC_DIRS[@]}"; do
		printf "DIR: ${entry}\n"
		for line in "${entry}"*; do
			printf "${line}\n"
			#printf "$(basename "${line}\n")"
		done
	done
}

# Main Program Logic ##########################################################

# Import configuration file
if [[ ! -f "${CONFIG_FILE}" ]]; then
	echo "Error: Config file not found at $CONFIG_FILE"
	exit 1
else
	source "${CONFIG_FILE}"
	# TODO filter out empty entries somewhere else; during listing
	unset CODOCS[0]  # remove the entry made during declaration
	unset CODOC_DIRS[0]  # remove the entry made during declaration
fi

# TODO put the known files into an array, iterate over array
case "${COMMAND}" in
	bashrc|sdiwctl|vimrc)
		;;
	codoc|codocrc)
		CODOC_TAG='COOD'
		CODOC_TAG+='OOC'
		;;
	info)
		list_info
		exit
		;;
	list)
		list_files
		exit
		;;
	*)
		printf "Unknown command: ${COMMAND}\n"
		exit
		;;
esac

TARGET_FILE="${CODOCS["${COMMAND}"]}"

printlines "${TARGET_FILE}"
